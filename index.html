<!DOCTYPE html>
<html lang="ja">
<head><meta charset="UTF-8"><title>„É°„Éà„É≠„Éé„Éº„É†ÔºàiOSÂØæÂøúÔºâ</title></head>
<body>
  <button id="startStop">„Çπ„Çø„Éº„ÉàÔºè„Çπ„Éà„ÉÉ„Éó</button>
  <canvas id="met" width="300" height="300"></canvas>
  <input id="bpm" type="number" value="60" min="20" max="300">
  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // üéß Unlock: „É¶„Éº„Ç∂„ÉºÊúÄÂàù„ÅÆÊìç‰Ωú„ÅßË§áÊï∞„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíListen„Åó resume + Á©∫„Éê„ÉÉ„Éï„Ç°ÂÜçÁîü
    function unlockAudio() {
      if (audioCtx.state !== 'suspended') return;
      const buffer = audioCtx.createBuffer(1, 1, 22050);
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.connect(audioCtx.destination);
      src.start(0);
      audioCtx.resume();
      ['touchstart','touchend','mousedown','keydown'].forEach(e =>
        document.body.removeEventListener(e, unlockAudio));
    }
    ['touchstart','touchend','mousedown','keydown'].forEach(e =>
      document.body.addEventListener(e, unlockAudio, false));
    
    let timer; let step = 0;
    const ctx = document.getElementById('met').getContext('2d');
    const bpmInput = document.getElementById('bpm');
    const btn = document.getElementById('startStop');

    function playClick() {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.frequency.value = 800;
      g.gain.setValueAtTime(0.2, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    function draw(s) {
      const r = 120, cx=150, cy=150;
      ctx.clearRect(0,0,300,300);
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.stroke();
      for(let i=0;i<16;i++){
        const a = i/16 * 2*Math.PI;
        const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
        ctx.beginPath();
        ctx.arc(x, y, i===s?10:5, 0, 2*Math.PI);
        ctx.fillStyle = i===s?'yellow':'gray';
        ctx.fill();
      }
    }

    btn.onclick = async () => {
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      if (timer) {
        clearInterval(timer); timer = null;
        btn.textContent = '„Çπ„Çø„Éº„Éà';
      } else {
        step = 0;
        const interval = (60 / bpmInput.value * 1000) / 4;
        draw(-1);
        timer = setInterval(() => {
          draw(step);
          playClick();
          step = (step + 1) % 16;
        }, interval);
        btn.textContent = '„Çπ„Éà„ÉÉ„Éó';
      }
    };

    draw(-1);
  </script>
</body>
</html>
