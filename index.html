<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>拡張メトロノーム（区間別リズム設定付き）</title>
  <style>
    /* （元のスタイルはそのまま） */
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 2rem;
      display: flex;
      gap: 2rem;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    canvas {
      background: #222;
      border-radius: 50%;
      margin-top: 1rem;
      box-shadow: 0 0 12px #000;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 320px;
    }
    .bpm-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .bpm-controls button {
      width: 2rem;
      height: 2rem;
      cursor: pointer;
      background: #444;
      border: none;
      border-radius: 4px;
      color: #eee;
      font-weight: bold;
      font-size: 1.2rem;
      transition: background 0.3s;
    }
    .bpm-controls button:hover {
      background: #ffaa00;
      color: #111;
    }
    .bpm-controls label {
      font-weight: bold;
      user-select: none;
    }
    .section-control {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      background: #222;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
    }
    .section-control button.section-btn {
      min-width: 90px;
      cursor: pointer;
      background: #444;
      border: none;
      color: #eee;
      border-radius: 4px;
      font-weight: bold;
      transition: background 0.3s;
      user-select: none;
      padding: 0.3rem 0.6rem;
    }
    .section-control button.section-btn.selected,
    .section-control button.section-btn:hover {
      background: #ffaa00;
      color: #111;
    }
    label {
      white-space: nowrap;
      user-select: none;
      font-size: 0.95rem;
    }
    select {
      background: #333;
      border: none;
      color: #eee;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.95rem;
      min-width: 90px;
      cursor: pointer;
      transition: background 0.3s;
    }
    select:hover {
      background: #555;
    }
    #startStop {
      margin-top: 1rem;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      background: #444;
      border: none;
      color: #eee;
      transition: background 0.3s;
    }
    #startStop:hover {
      background: #ffaa00;
      color: #111;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="bpm-controls">
      <label for="bpm-value">BPM:</label>
      <button id="bpm-down">−</button>
      <span id="bpm-value">60</span>
      <button id="bpm-up">＋</button>
    </div>

    <div class="section-control" data-set="0">
      <button class="section-btn selected">1～4小節</button>
      <label>リズム
        <select class="subdivision-select">
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3" selected>3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
      <label>第2リズム
        <select class="second-subdivision-select">
          <option value="0">なし</option>
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3">3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
    </div>
    <div class="section-control" data-set="1">
      <button class="section-btn">5～8小節</button>
      <label>リズム
        <select class="subdivision-select">
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3" selected>3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
      <label>第2リズム
        <select class="second-subdivision-select">
          <option value="0">なし</option>
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3">3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
    </div>
    <div class="section-control" data-set="2">
      <button class="section-btn">9～12小節</button>
      <label>リズム
        <select class="subdivision-select">
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3" selected>3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
      <label>第2リズム
        <select class="second-subdivision-select">
          <option value="0">なし</option>
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3">3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
    </div>
    <div class="section-control" data-set="3">
      <button class="section-btn">13～16小節</button>
      <label>リズム
        <select class="subdivision-select">
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3" selected>3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
      <label>第2リズム
        <select class="second-subdivision-select">
          <option value="0">なし</option>
          <option value="1">4分音符</option>
          <option value="2">8分音符</option>
          <option value="3">3連符</option>
          <option value="4">16分音符</option>
          <option value="6">6連符</option>
        </select>
      </label>
    </div>

    <button id="startStop">スタート</button>
  </div>

  <canvas id="metronome" width="400" height="400"></canvas>

  <script>
    const canvas = document.getElementById("metronome");
    const ctx = canvas.getContext("2d");

    const bpmUpBtn = document.getElementById("bpm-up");
    const bpmDownBtn = document.getElementById("bpm-down");
    const bpmValue = document.getElementById("bpm-value");
    const startStopBtn = document.getElementById("startStop");

    const sectionControls = document.querySelectorAll(".section-control");
    const sectionButtons = document.querySelectorAll(".section-btn");

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    let running = false;
    let angle = -Math.PI / 2;
    let lastTime = 0;

    let bpm = 60;
    let rotationSpeed = 2 * Math.PI * bpm / 60;

    // 各区間の設定を保持する配列
    let settingsSequence = [
      { subdivision: 3, secondSubdivision: 0 },
      { subdivision: 3, secondSubdivision: 0 },
      { subdivision: 3, secondSubdivision: 0 },
      { subdivision: 3, secondSubdivision: 0 },
    ];

    // 現在選択中の区間インデックス
    let currentSetIndex = 0;

    let triggerAngles = [];
    let secondTriggerAngles = [];

    // 小節カウント
    let measureCount = 0;

    // UI初期化＆同期
    function updateUIForSet(setIndex) {
      const sc = sectionControls[setIndex];
      sc.querySelector(".subdivision-select").value = settingsSequence[setIndex].subdivision;
      sc.querySelector(".second-subdivision-select").value = settingsSequence[setIndex].secondSubdivision;
      // 選択ボタンのハイライト同期
      sectionButtons.forEach(btn => btn.classList.remove("selected"));
      sectionButtons[setIndex].classList.add("selected");
    }

    // 現在の設定を描画用に反映
    function applySettings(setIndex) {
      const s = settingsSequence[setIndex];
      subdivision = s.subdivision;
      secondSubdivision = s.secondSubdivision;
      rotationSpeed = 2 * Math.PI * bpm / 60;

      // 第1リズムの角度配列作成
      triggerAngles = [];
      for (let i = 0; i < subdivision; i++) {
        let ang = (2 * Math.PI) * (i / subdivision) - Math.PI / 2;
        triggerAngles.push({ angle: ang, triggered: false });
      }
      // 第2リズムの角度配列作成
      secondTriggerAngles = [];
      for (let i = 0; i < secondSubdivision; i++) {
        let ang = (2 * Math.PI) * (i / secondSubdivision) - Math.PI / 2;
        secondTriggerAngles.push({ angle: ang, triggered: false });
      }
      draw();
    }

    // BPM表示更新
    function updateBPMDisplay() {
      bpmValue.textContent = bpm;
      rotationSpeed = 2 * Math.PI * bpm / 60;
      if (running) {
        applySettings(currentSetIndex);
      }
    }

    // 音鳴らし関数
    function playClick(isAccent, isSecond = false) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = "sine";
      if (isSecond) {
        osc.frequency.setValueAtTime(isAccent ? 800 : 400, audioCtx.currentTime);
      } else {
        osc.frequency.setValueAtTime(isAccent ? 1000 : 600, audioCtx.currentTime);
      }
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + 0.1);
    }

    // 描画関数
    function draw(flashIndex = -1, secondFlashIndex = -1) {
      const cx = canvas.width / 2;
      const cy = canvas.height / 2;
      const rOuter = 150;
      const rInner = 115;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 第1リズム（外周マーカー）
      for (let i = 0; i < subdivision; i++) {
        const ang = (2 * Math.PI) * (i / subdivision) - Math.PI / 2;
        const mx = cx + rOuter * Math.cos(ang);
        const my = cy + rOuter * Math.sin(ang);
        ctx.beginPath();
        ctx.arc(mx, my, 8, 0, 2 * Math.PI);
        ctx.fillStyle = (i === flashIndex) ? "yellow" : "#ccbb33";
        ctx.shadowColor = (i === flashIndex) ? "yellow" : "transparent";
        ctx.shadowBlur = (i === flashIndex) ? 15 : 0;
        ctx.fill();
      }

      // 第2リズム（内側マーカー）
      for (let i = 0; i < secondSubdivision; i++) {
        const ang = (2 * Math.PI) * (i / secondSubdivision) - Math.PI / 2;
        const mx = cx + rInner * Math.cos(ang);
        const my = cy + rInner * Math.sin(ang);
        ctx.beginPath();
        ctx.arc(mx, my, 8, 0, 2 * Math.PI);
        ctx.fillStyle = (i === secondFlashIndex) ? "#0ff" : "#088";
        ctx.shadowColor = (i === secondFlashIndex) ? "#0ff" : "transparent";
        ctx.shadowBlur = (i === secondFlashIndex) ? 10 : 0;
        ctx.fill();

        // 中心点を背景色で塗りつぶし
        ctx.beginPath();
        ctx.arc(mx, my, 2.5, 0, 2 * Math.PI);
        ctx.fillStyle = "#111";
        ctx.fill();
      }

      // 回転円
      ctx.beginPath();
      ctx.arc(cx, cy, rOuter, 0, 2 * Math.PI);
      ctx.strokeStyle = "#444";
      ctx.lineWidth = 3;
      ctx.stroke();

      // ポインター
      const px = cx + rOuter * Math.cos(angle);
      const py = cy + rOuter * Math.sin(angle);
      ctx.beginPath();
      ctx.arc(px, py, 10, 0, 2 * Math.PI);
      ctx.fillStyle = "yellow";
      ctx.shadowColor = "yellow";
      ctx.shadowBlur = 10;
      ctx.fill();

      // 中心点
      ctx.beginPath();
      ctx.arc(cx, cy, 5, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.fill();
    }

    // 角度差計算（ラップ含む）
    function angleDiff(a, b) {
      return Math.abs(Math.atan2(Math.sin(a - b), Math.cos(a - b)));
    }

    // クリックカウント
    let clickCount = 0;

    // メインループ
    function loop(time) {
      if (!running) return;
      const dt = (time - lastTime) / 1000;
      lastTime = time;
      angle += rotationSpeed * dt;
      if (angle > Math.PI) {
        angle -= 2 * Math.PI;
        triggerAngles.forEach(t => t.triggered = false);
        secondTriggerAngles.forEach(t => t.triggered = false);
      }

      let flashIndex = -1;
      triggerAngles.forEach((t, i) => {
        const diff = angleDiff(angle, t.angle);
        if (diff < 0.05 && !t.triggered) {
          t.triggered = true;
          flashIndex = i;
          playClick(i === 0, false);

          // クリックカウント増加（第1リズムのみ）
          clickCount++;
          // 4小節 × subdivision 回のクリックで区間切替
          if (clickCount >= subdivision * 4) {
            clickCount = 0;
            measureCount += 4;
            currentSetIndex = (currentSetIndex + 1) % settingsSequence.length;
            applySettings(currentSetIndex);
            updateUIForSet(currentSetIndex);
          }
        }
      });

      let secondFlashIndex = -1;
      secondTriggerAngles.forEach((t, i) => {
        const diff = angleDiff(angle, t.angle);
        if (diff < 0.05 && !t.triggered) {
          t.triggered = true;
          secondFlashIndex = i;
          playClick(i === 0, true);
        }
      });

      draw(flashIndex, secondFlashIndex);
      requestAnimationFrame(loop);
    }

    // BPMボタンイベント
    bpmUpBtn.onclick = () => {
      if (bpm < 300) bpm++;
      updateBPMDisplay();
    };
    bpmDownBtn.onclick = () => {
      if (bpm > 20) bpm--;
      updateBPMDisplay();
    };

    // セクションボタンのクリックで切替
    sectionButtons.forEach((btn, idx) => {
      btn.onclick = () => {
        // 選択強調
        sectionButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        currentSetIndex = idx;
        clickCount = 0;
        applySettings(currentSetIndex);
        updateUIForSet(currentSetIndex);
      };
    });

    // セレクトメニュー変更時に設定更新
    sectionControls.forEach((sc, idx) => {
      sc.querySelector(".subdivision-select").onchange = (e) => {
        settingsSequence[idx].subdivision = parseInt(e.target.value);
        if (idx === currentSetIndex) applySettings(currentSetIndex);
      };
      sc.querySelector(".second-subdivision-select").onchange = (e) => {
        settingsSequence[idx].secondSubdivision = parseInt(e.target.value);
        if (idx === currentSetIndex) applySettings(currentSetIndex);
      };
    });

    // スタート／ストップ
    startStopBtn.onclick = async () => {
      if (audioCtx.state === "suspended") await audioCtx.resume();
      running = !running;
      startStopBtn.textContent = running ? "ストップ" : "スタート";
      if (running) {
        lastTime = performance.now();
        angle = -Math.PI / 2;
        clickCount = 0;
        measureCount = 0;
        applySettings(currentSetIndex);
        updateUIForSet(currentSetIndex);
        requestAnimationFrame(loop);
      }
    };

    // 最初のUI同期
    for(let i=0; i < settingsSequence.length; i++){
      updateUIForSet(i);
    }
    applySettings(currentSetIndex);
    updateBPMDisplay();
    draw();
  </script>
</body>
</html>
